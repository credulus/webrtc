<button id="check">Check</button>
<button id="close">Close</button>

<hr>
<button id="share-file" disabled>Share File</button><hr>
<div id="container"></div>
<div id="room_container"><a class="rooms-list"></a></div>

<br><br>

<div id="chat-container">
    <input type="text" id="input-text-chat" placeholder="Enter Text Chat" disabled><br>
    <div class="chat-output"></div>
</div>

<link rel="stylesheet" href="style.css">

<script src="/reliable-signaler/signaler.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="//api.turnservers.com/api.js?key=ZDLxtExtLbafFWQXXLAdrEbPkSuEcBuL"></script>

<script src="/RTCMultiConnection.js"></script>
<script src="https://cdn.webrtc-experiment.com/FileBufferReader.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script>
// initializing RTCMultiConnection constructor.
var connection = new RTCMultiConnection();

connection.body = document.getElementById('container');

// using reliable-signaler
var signaler = initReliableSignaler(connection, '/');

connection.session = {
    audio: true,
    video: true,
    data: true
};

connection.sdpConstraints.mandatory = {
    OfferToReceiveAudio: true,
    OfferToReceiveVideo: true
};

var videoConstraints = {
    mandatory: {
        maxWidth: 1920,
        maxHeight: 1080,
        minAspectRatio: 1.77,
        minFrameRate: 3,
        maxFrameRate: 64
    },
    optional: []
};

var audioConstraints = {
    mandatory: {
        // echoCancellation: false,
        // googEchoCancellation: false, // disabling audio processing
        // googAutoGainControl: true,
        // googNoiseSuppression: true,
        // googHighpassFilter: true,
        // googTypingNoiseDetection: true,
        // googAudioMirroring: true
    },
    optional: []
};

connection.mediaConstraints = {
    video: videoConstraints,
    audio: audioConstraints
};

/*document.getElementById('open').onclick = function() {
    var sessionid = document.getElementById('session-id').value;
    if (sessionid.replace(/^\s+|\s+$/g, '').length <= 0) {
        alert('Please enter session-id');
        document.getElementById('session-id').focus();
        return;
    }

    this.disabled = true;

    connection.channel = connection.sessionid = connection.userid = sessionid;
    connection.open({
        onMediaCaptured: function() {
            signaler.createNewRoomOnServer(connection.sessionid);
        }
    });
};*/
window.onload = function() {
    
};

/*document.getElementByClassName('rooms-list').onclick = function() {

    var sessionid = this.data;
    console.log(sessionid);
    /*if (sessionid.replace(/^\s+|\s+$/g, '').length <= 0) {
        alert('Please enter session-id');
        document.getElementById('session-id').focus();
        return;
    }* /

    this.disabled = true;
    signaler.getRoomFromServer(sessionid, function(sessionid) {
        connection.channel = connection.sessionid = sessionid;
        connection.join({
            sessionid: sessionid,
            userid: sessionid,
            extra: {},
            session: connection.session
        });
    });
};*/
roomflag = false;
jQuery(document).ready(function(){


        jQuery(document).on('click','.rooms-list',function() {

        var sessionid = jQuery(this).attr('data');
        console.log(sessionid);
        /*if (sessionid.replace(/^\s+|\s+$/g, '').length <= 0) {
            alert('Please enter session-id');
            document.getElementById('session-id').focus();
            return;
        }*/

        this.disabled = true;
        signaler.getRoomFromServer(sessionid, function(sessionid) {
            connection.channel = connection.sessionid = sessionid;
            connection.join({
                sessionid: sessionid,
                userid: sessionid,
                extra: {},
                session: connection.session
            });
        });
    });

        jQuery('#check').click(function() {

        signaler.checkRoomFromServer(function(roomlist){
            if(!roomlist) {
                console.log('no room found');
                return;
            }
            document.getElementById('room_container').innerHTML = '';
            for(var i in roomlist){
                document.getElementById('room_container').innerHTML = document.getElementById('room_container').innerHTML + '<a class="rooms-list" id="'+roomlist[i]+'" href="#" data="'+roomlist[i]+'">'+roomlist[i]+'</a><br>';
                roomflag = true;
            }
        });
    });

    setInterval(function(){jQuery('#check').trigger('click'); console.log('check')},1000);
    
    connection.onstatechange = function (state) {
	    // state.userid == 'target-userid' || 'browser'
	    // state.extra  == 'target-user-extra-data' || {}
	    // state.name  == 'short name'
	    // state.reason == 'longer description'
	    console.log("ramesh:"+state.name);
	    if(state.name == 'stop-request-denied') {
	        alert(state.reason);
	    }
	};
    /*roomflag = function(){
         signaler.checkRoomFromServer(function(roomlist){
            if(roomlist) {
                return true;
            }
            else
                return false;
        })
    };
    if(!roomflag){*/

     

    jQuery('#close').click(function() {     
        //connection.removeStream(connection.sessionid);
        //connection.isInitiator = true;
         connection.sessionid = null;
        connection.leave();    
       location.reload();
    });

});

document.getElementById('share-file').onclick = function() {
    var fileSelector = new FileSelector();
    fileSelector.selectSingleFile(function(file) {
        connection.send(file);
    });
};

connection.onopen = function() {
    document.getElementById('share-file').disabled = false;
    document.getElementById('input-text-chat').disabled = false;
};

document.getElementById('input-text-chat').onkeyup = function(e) {
    if(e.keyCode != 13) return;
    
    // removing trailing/leading whitespace
    this.value = this.value.replace(/^\s+|\s+$/g, '');

    if (!this.value.length) return;
    
    connection.send(this.value);
    appendDIV(this.value);
    this.value =  '';
};

connection.onmessage = appendDIV;

var chatContainer = document.querySelector('.chat-output');

// a custom method used to append a new DIV into DOM
function appendDIV(event) {
    var div = document.createElement('div');
    div.innerHTML = event.data || event;
    chatContainer.insertBefore(div, chatContainer.firstChild);
    div.tabIndex = 0; div.focus();
    
    document.getElementById('input-text-chat').focus();
}
</script>
